parameters:
  versionSpec: ''

steps:
  # use python 3.8 for tooling. packaging. platform.
  - task: UsePythonVersion@0
    displayName: "Use Python 3.8"
    inputs:
      versionSpec: 3.8

  - pwsh: |
      python -m pip install packaging==23.1
    displayName: Prep Environment

  - script: |
      curl -L -o pypy3.9-v7.3.16-macos_x86_64.tar.bz2 https://downloads.python.org/pypy/pypy3.9-v7.3.16-macos_x86_64.tar.bz2

      # Unzip (untar) the file to the target directory
      mkdir -p $(AGENT_TOOLSDIRECTORY)/PyPy/3.9.4
      tar -xvjf pypy3.9-v7.3.16-macos_x86_64.tar.bz2 -C $(AGENT_TOOLSDIRECTORY)/PyPy/3.9.4 --strip-components=1
      chmod -R 0755 $(AGENT_TOOLSDIRECTORY)/PyPy/3.9.4/bin
    displayName: Install pypy39 to hosted tool cache
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

  - pwsh: |
      Get-ChildItem -Force -Recurse $(AGENT_TOOLSDIRECTORY)/PyPy
    displayName: Dump Hosted Tool Cache for PyPy
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

  - pwsh: |
      Get-ChildItem -Force -Recurse $(AGENT_TOOLSDIRECTORY)/Python
    displayName: Dump Hosted Tool Cache for Python
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))

  # select the appropriate version from manifest if present
  - task: PythonScript@0
    displayName: 'Install ${{ parameters.versionSpec }} from Python Manifest If Necessary'
    inputs:
     scriptPath: 'scripts/devops_tasks/install_python_version.py'
     arguments: '${{ parameters.versionSpec }} --installer_folder="../_pyinstaller'

  # set up bypass of standard use python version
  - pwsh: |
      $incoming = "${{ parameters.versionSpec }}"

      if($incoming.Contains("pypy3")){
        Write-Host "##vso[task.setvariable variable=ManualInstallNecessary]true"
      }
    displayName: Check UsePythonVersion Necessity

  - pwsh: |
      Write-Host "##vso[task.prependpath]$(AGENT_TOOLSDIRECTORY)/PyPy/3.9.4/x64"
      Write-Host "##vso[task.prependpath]$(AGENT_TOOLSDIRECTORY)/PyPy/3.9.4/x64/bin"
    displayName: 'PyPy3 Specific Path Prepend'
    condition: and(succeeded(), eq(variables.ManualInstallNecessary, 'true'))

  - task: UsePythonVersion@0
    displayName: "Use Python $(PythonVersion)"
    condition: and(succeeded(), not(eq(variables.ManualInstallNecessary, 'true')))
    inputs:
      versionSpec: ${{ parameters.versionSpec }}
