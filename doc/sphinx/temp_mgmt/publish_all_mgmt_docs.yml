 parameters:
  - name: MgmtPackages
    type: object
    default:
      azure-mgmt-advisor:
        ServiceDirectory: advisor
        Version: '9.0.0'
      azure-mgmt-iothub:
        ServiceDirectory: iothub
        Version: '3.0.0'
      azure-mgmt-iothubprovisioningservices:
        ServiceDirectory: iothub
        Version: '1.2.0b2'

 steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.11'
    inputs:
      versionSpec: '3.11'
  
  - script: |
      python -m pip install setuptools==58.3.0
      python -m pip install -r eng/ci_tools.txt
    displayName: 'Prep Environment'

  - ${{ each pkg in parameters.MgmtPackages }}:
    - task: PythonScript@0
      displayName: 'checkout library tag'
      inputs:
        scriptPath: 'doc/sphinx/temp_mgmt/checkout_tag.py'
        arguments: >-
          --package=${{ pkg.key }}
          --service=${{ pkg.value.ServiceDirectory }}
          --version=${{ pkg.value.Version }}

    - task: PythonScript@0
      displayName: 'Generate Docs'
      inputs:
        scriptPath: 'scripts/devops_tasks/dispatch_tox.py'
        arguments: >-
          ${{ pkg.key }}
          --service=${{ pkg.value.ServiceDirectory }}
          --toxenv=sphinx

  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/_docs'
      ArtifactName: 'documentation'
